<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL SQL Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar: Configuration & Inputs -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <span class="brand-name">SQL Generator Demo</span>
            </div>

            <div class="sidebar-scroll-area">
                <!-- Data Source: Real DB Connection Only -->
                <div class="sidebar-section collapsible" id="dbSection">
                    <div class="section-header" id="dbSectionHeader">
                        <div class="section-title">Database Connection</div>
                        <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    
                    <div class="connection-status-bar" id="connectionStatus">
                        <span class="status-dot disconnected"></span>
                        <span class="status-text">Disconnected</span>
                    </div>

                    <div class="form-group hidden" id="extractMetadataGroup">
                        <div class="side-by-side">
                            <button class="btn-ghost" id="extractMetadataBtn">
                                üì• Extract Schema
                            </button>
                            <button class="btn-icon-ghost" id="viewMetadataBtn" title="View Raw Metadata">
                                üîç
                            </button>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        <div id="realDbSection">
                            <div class="form-group">
                                <label class="section-subtitle">Saved Connections</label>
                                <select id="quickConnectSelect" class="form-select">
                                    <option value="">Select Favorite...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="section-subtitle">Type</label>
                                <select id="dbTypeSelect" class="form-select">
                                    <option value="postgresql">PostgreSQL</option>
                                    <option value="mysql">MySQL</option>
                                </select>
                            </div>

                            <div class="connection-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Host</label>
                                        <input type="text" id="dbHost" class="form-input" value="localhost">
                                    </div>
                                    <div class="form-group">
                                        <label>Port</label>
                                        <input type="number" id="dbPort" class="form-input" value="5432">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Database</label>
                                    <input type="text" id="dbName" class="form-input" placeholder="db_name">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>User</label>
                                        <input type="text" id="dbUser" class="form-input" placeholder="user">
                                    </div>
                                    <div class="form-group">
                                        <label>Password</label>
                                        <input type="password" id="dbPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                </div>
                            </div>

                            <div class="connection-actions">
                                <button class="btn-primary full-width" id="connectBtn">Connect</button>
                                <button class="btn-secondary full-width hidden" id="disconnectBtn">Disconnect</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query Input Section -->
                <div class="sidebar-section">
                    <div class="section-title">Query</div>
                    
                    <div class="form-group option-row">
                        <input type="checkbox" id="includeEtl">
                        <label for="includeEtl">Generate ETL Pipeline</label>
                    </div>

                    <div class="form-group">
                        <textarea id="queryInput" class="query-input" placeholder="Describe your data requirement..."></textarea>
                    </div>
<div class="form-group">
    <label class="section-subtitle" for="llmSelect">LLM Model</label>
    <select id="llmSelect" class="form-select">
        <option value="gpt-5.2-2025-12-11">OpenAI High (5.2)</option>
        <option value="gpt-5-mini-2025-08-07" selected>OpenAI Middle (5-mini)</option>
        <option value="gpt-5-nano-2025-08-07">OpenAI Low (5-nano)</option>
        <option value="gemini-3.0-flash">Gemini (3.0 flash)</option>
    </select>
</div>
                    <button class="btn-generate" id="generateBtn">
                        Generate SQL
                    </button>

                    <button class="btn-execute hidden" id="executeBtn">
                        Run Query
                    </button>
                </div>
                
                <!-- Examples -->
                <div class="sidebar-section examples-section hidden" id="examplesSection">
                     <div class="section-title">
                        Suggested Queries
                        <button class="refresh-btn" id="refreshSamplesBtn" title="Refresh Suggestions">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                        </button>
                     </div>
                     <div class="example-list" id="exampleList"></div>
                </div>
            </div>
            
            <div class="sidebar-footer">
               <div class="badge-group">
                 <span class="badge badge-safe">Read Only</span>
               </div>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="workspace">
            <header class="workspace-header">
                <div class="breadcrumbs">
                    <div class="workspace-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M3 9h18"/>
                        </svg>
                    </div>
                    <span class="crumb">Default Project</span>
                    <span class="separator">/</span>
                    <span class="crumb active">Query Generation</span>
                </div>
                <div class="header-actions">
                     <button class="btn-icon" id="copyBtn" disabled title="Copy SQL">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                           <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                           <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                     </button>
                </div>
            </header>
            
            <div class="workspace-content split-view">
                <!-- Left Column: Generation Results -->
                <div class="content-left">
                    <!-- Loading -->
                    <div class="loading-state hidden" id="loading">
                        <div class="spinner"></div>
                        <p>Generating optimal SQL query...</p>
                    </div>

                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-illustration">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <h2>Data Workspace</h2>
                        <p>Configure your data source in the sidebar and enter a natural language query to get started.</p>
                    </div>

                    <!-- Results Area -->
                    <div class="result-container hidden" id="resultContainer">
                        
                        <!-- Intent Card -->
                        <div class="result-card" id="intentSection">
                            <div class="card-header">
                                <h3>Interpretation</h3>
                            </div>
                            <div class="card-body">
                                <p id="intentSummary">-</p>
                            </div>
                        </div>

                        <!-- SQL Card (Editable) -->
                        <div class="result-card sql-card" id="sqlSection">
                            <div class="card-header">
                                <h3>Generated SQL</h3>
                                <div class="header-actions">
                                    <span class="lang-badge">SQL</span>
                                    <button class="btn-xs-primary" id="runQueryBtn">
                                        Run
                                    </button>
                                </div>
                            </div>
                            <div class="card-body code-body">
                                <textarea class="sql-code-editor" id="sqlCodeEditor" spellcheck="false"></textarea>
                            </div>
                        </div>

                        <!-- Blocked Warning -->
                        <div class="result-card warning-card hidden" id="blockedSection">
                            <div class="card-header">
                                <h3>‚ö†Ô∏è Request Blocked</h3>
                            </div>
                            <div class="card-body">
                                <p id="blockReason"></p>
                            </div>
                        </div>

                        <div class="row-2-col">
                            <!-- Assumptions -->
                            <div class="result-card" id="assumptionsSection">
                                <div class="card-header">
                                    <h3>Assumptions</h3>
                                </div>
                                <div class="card-body">
                                    <ul id="assumptionsList" class="info-list"></ul>
                                </div>
                            </div>

                            <!-- Tables Used -->
                            <div class="result-card" id="tablesSection">
                                <div class="card-header">
                                    <h3>Tables Referenced</h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-tags" id="tablesList"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Safety -->
                        <div class="result-card info-card" id="safetySection">
                            <div class="card-header">
                                <h3>Safety Notes</h3>
                            </div>
                            <div class="card-body">
                                <ul id="safetyList" class="info-list"></ul>
                            </div>
                        </div>

                        <!-- ETL Pipeline -->
                        <div class="result-card etl-card hidden" id="etlSection">
                            <div class="card-header">
                                <h3>ETL Pipeline Visualization</h3>
                            </div>
                            <div class="card-body">
                                <div class="etl-pipeline" id="etlPipeline"></div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Right Column: Execution Results -->
                <div class="content-right hidden" id="executionPanel">
                    <div class="result-card full-height">
                        <div class="card-header">
                            <h3>Execution Results</h3>
                            <button class="btn-icon-sm" id="closeExecutionPanel">
                                ‚úï
                            </button>
                        </div>
                        <div class="card-body scrollable" id="queryResultContainer">
                            <div class="empty-result-msg">
                                Run a query to see results here.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    
    <!-- Metadata Viewer Modal -->
    <div id="metadataModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Extracted Schema (JSON)</h3>
                <button class="btn-close" id="closeMetadataModal">‚úï</button>
            </div>
            <div class="modal-body">
                <pre id="metadataJsonViewer"></pre>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Check initial state
        const resultContainer = document.getElementById('resultContainer');
        const emptyState = document.getElementById('emptyState');
        
        // Function to toggle views
        function toggleView() {
            const loading = document.getElementById('loading');
            const isLoading = loading && !loading.classList.contains('hidden');
            const isResultVisible = !resultContainer.classList.contains('hidden') && resultContainer.style.display !== 'none';
            
            if (isResultVisible || isLoading) {
                emptyState.classList.add('hidden');
            } else {
                emptyState.classList.remove('hidden');
            }
        }

        // Observe changes
        const observer = new MutationObserver(toggleView);
        observer.observe(resultContainer, { attributes: true, attributeFilter: ['class', 'style'] });
        const loadingEl = document.getElementById('loading');
        if (loadingEl) {
            observer.observe(loadingEl, { attributes: true, attributeFilter: ['class'] });
        }
        
        // Initial check
        toggleView();
        
        // Hack to ensure logic works with existing app.js toggling
        setInterval(toggleView, 500); 
    </script>
</body>
</html>
